delete vlans
{% for interface, _ in interfaces.items() %}
delete interfaces {{ interface }}
delete poe interface {{ interface }}
{% endfor %}

set vlans default vlan-id 1
set vlans default l3-interface irb.0
set vlans "{{ mgmt_vlan.name }}" vlan-id {{ mgmt_vlan.vid }}
set vlans "{{ mgmt_vlan.name }}" l3-interface irb.{{ mgmt_vlan.vid }}
{% for vlan in vlans %}
{% if vlan.used %}
set vlans "{{ vlan.name }}" vlan-id {{ vlan.vid }}
{% endif %}
{% endfor %}

{% for interface, prop in interfaces.items() %}

{% if prop.enabled %}
set interfaces {{ interface }} enable
{% else %}
set interfaces {{ interface }} disable
{% endif %}

{% if prop.description %}
set interfaces {{ interface }} description "{{ prop.description }}"
{% endif %}

{% if prop.physical and prop.mode %}
set interfaces {{ interface }} unit 0 family ethernet-switching interface-mode {{ prop.mode }}
{% for vlan in prop.vlans %}
set interfaces {{ interface }} unit 0 family ethernet-switching vlan members {{ vlan }}
{% endfor %}
{% elif prop.mode %}
set interfaces {{ interface }} unit 0 family ethernet-switching interface-mode {{ prop.mode }}
{% for vlan in prop.vlans %}
set interfaces {{ interface }} unit 0 family ethernet-switching vlan members {{ vlan }}
{% endfor %}
{% endif %}
{% if prop.native %}
set interfaces {{ interface }} native-vlan-id {{ prop.native }}
{% endif %}

{% if prop.physical %}
set interfaces {{ interface }} unit 0 family ethernet-switching storm-control default
{% if prop.auto_speed %}
set interfaces {{ interface }} ether-options auto-negotiation
{% else %}
set interfaces {{ interface }} speed {{ prop.speed }}
{% endif %}
{% if prop.poe %}
set poe interface {{ interface }}
{% endif %}
{% endif %}

{% endfor %}

{% for parent, children in lag_members.items() %}
set interfaces {{ parent }} aggregated-ether-options lacp active
{% for child in children %}
set interfaces {{ child }} ether-options 802.3ad {{ parent }}
{% endfor %}
{% endfor %}
